<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מחשבון Rotation Distance ל‑Klipper</title>
  <style>
    :root { --bg:#0b0f14; --card:#121822; --ink:#e6edf3; --muted:#9fb3c8; --accent:#7aa2f7; --good:#7ee787; --bad:#ff7b72; }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0f14 0%,#0e141b 100%);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:960px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    .logo{width:36px;height:36px;border-radius:12px;background:radial-gradient(80% 80% at 25% 20%,#2b80ff,transparent),linear-gradient(135deg,#1e293b,#0b1220);box-shadow:0 6px 24px rgba(0,0,0,.35)}
    h1{font-size:22px;margin:0}
    .card{background:var(--card);border:1px solid #1f2a38;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:18px;margin:14px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    label{display:block;font-weight:600;margin-bottom:6px;color:var(--muted)}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3a4f;background:#0d1320;color:var(--ink)}
    input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px #7aa2f733}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button{padding:10px 14px;border:0;border-radius:12px;background:var(--accent);color:#081018;font-weight:700;cursor:pointer}
    button.secondary{background:#1f2a38;color:var(--ink)}
    .result{font-size:18px;font-weight:800}
    .small{font-size:13px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #223048;background:#0f1520;color:var(--muted);padding:6px 10px;border-radius:999px}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .ok{color:var(--good)} .bad{color:var(--bad)}
    .footer{opacity:.8;margin-top:18px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <h1>מחשבון <span class="mono">rotation_distance</span> ל‑Klipper</h1>
    </header>

    <div class="card">
      <div class="grid">
        <div>
          <label>מרחק מסומן התחלתי (מ"מ)</label>
          <input id="mark" type="number" step="0.01" value="120" />
          <div class="small">ברירת מחדל: 120 מ"מ</div>
        </div>
        <div>
          <label>אורך פקודה להזנה (מ"מ)</label>
          <input id="commanded" type="number" step="0.01" value="100" />
          <div class="small">ברירת מחדל: 100 מ"מ</div>
        </div>
        <div>
          <label>מרחק שנשאר אחרי ההזנה (מ"מ)</label>
          <input id="remaining" type="number" step="0.01" placeholder="לדוגמה: 22.3" />
        </div>
        <div>
          <label><span class="mono">rotation_distance</span> נוכחי</label>
          <input id="rd_old" type="number" step="0.001" value="3.433" />
          <div class="small">ברירת מחדל: 3.433 (ניתן לשינוי)</div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="calc">חשב</button>
        <button id="copy" class="secondary">העתק תוצאה</button>
        <span id="status" class="pill">מוכן</span>
      </div>
      <div id="out" class="result" style="margin-top:12px"></div>
      <div id="details" class="small mono" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <div class="small">
        נוסחה: <span class="mono">extruded_actual = mark - remaining</span> ·
        <span class="mono">rotation_distance_new = rotation_distance_old × (extruded_actual / commanded)</span>
      </div>
      <div class="footer">טיפ: שמרתי ערכים אחרונים בלוקאל‑סטורג׳ של הדפדפן שלך לנוחות.</div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const fmt = (n, d=3) => isFinite(n) ? Number(n).toFixed(d) : "";

    function load() {
      const keys = ["mark","commanded","remaining","rd_old"]; keys.forEach(k=>{ const v = localStorage.getItem("rd_"+k); if(v!==null) $("#"+k).value = v; });
    }
    function save() {
      const keys = ["mark","commanded","remaining","rd_old"]; keys.forEach(k=> localStorage.setItem("rd_"+k, $("#"+k).value));
    }

    function compute(){
      const mark = parseFloat($("#mark").value);
      const commanded = parseFloat($("#commanded").value);
      const remaining = parseFloat($("#remaining").value);
      const rd_old = parseFloat($("#rd_old").value);
      if(![mark,commanded,remaining,rd_old].every(Number.isFinite)){
        $("#status").textContent = "חסר נתונים"; $("#status").className = "pill bad"; return;
      }
      const extruded_actual = mark - remaining;
      const ratio = extruded_actual / commanded;
      const rd_new = rd_old * ratio;
      const drift = (extruded_actual - commanded);
      $("#out").textContent = `תוצאה אחרי כיול: ${fmt(rd_new, 3)}`;
      $("#details").textContent = `extruded_actual = ${fmt(extruded_actual,2)} מ"מ · יחס = ${fmt(ratio,4)} · סטייה = ${fmt(drift,2)} מ"מ`;
      $("#status").textContent = Math.abs(drift) <= 1 ? "סטייה נמוכה" : "בדוק שוב מדידה";
      $("#status").className = "pill " + (Math.abs(drift) <= 1 ? "ok" : "bad");
      save();
      return rd_new;
    }

    $("#calc").addEventListener("click", compute);
    $("#copy").addEventListener("click", ()=>{
      const outText = $("#out").textContent.trim();
      const numOnly = outText.replace(/[^0-9.\-]/g, '');
      if(!numOnly) return;
      navigator.clipboard.writeText(numOnly).then(()=>{
        $("#status").textContent = "הועתק";
        $("#status").className = "pill ok";
      });
    });
    load();
  </script>
</body>
</html>
